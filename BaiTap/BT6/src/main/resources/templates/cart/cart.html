<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Gi·ªè h√†ng - Web B√°n H√†ng</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<section layout:fragment="content" class="container mt-4">
    <h1 class="mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h1>

    <div id="cart-empty" class="alert alert-info" style="display: none;">
        Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.
    </div>

    <div id="cart-container" style="display: none;">
        <table class="table table-bordered align-middle">
            <thead class="table-light">
            <tr>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th style="width: 150px;">S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
                <th style="width: 100px;">üõ†Ô∏è</th>
            </tr>
            </thead>
            <tbody id="cart-items-body">
            </tbody>
        </table>

        <div class="text-end mt-4">
            <h4>T·ªïng s·ªë l∆∞·ª£ng: <span id="total-quantity">0</span></h4>
            <h3>T·ªïng ti·ªÅn: <span class="text-danger" id="total-price">0 VNƒê</span></h3>
        </div>

        <div class="mt-4 d-flex justify-content-between">
            <a th:href="@{/products}" class="btn btn-info">Ti·∫øp t·ª•c mua h√†ng</a>
            <div>
                <button onclick="clearCart()" class="btn btn-secondary me-2">L√†m s·∫°ch gi·ªè h√†ng</button>
                <a th:href="@{/order/checkout}" class="btn btn-primary">Thanh to√°n</a>
            </div>
        </div>
    </div>
</section>

<th:block layout:fragment="scripts">
    <script>
        // H√†m ƒë·ªãnh d·∫°ng s·ªë
        function formatNumber(num) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(num);
        }

        // T·∫£i v√† hi·ªÉn th·ªã gi·ªè h√†ng
        function loadCart() {
            $.ajax({
                url: '/api/cart/details',
                type: 'GET',
                success: function(response) {
                    const { cartItems, sumPrice, sumQuantity } = response;
                    const cartBody = $('#cart-items-body');
                    cartBody.empty();

                    if (cartItems.length === 0) {
                        $('#cart-container').hide();
                        $('#cart-empty').show();
                    } else {
                        $('#cart-container').show();
                        $('#cart-empty').hide();

                        cartItems.forEach(item => {
                            const row = `<tr>
                                <td>${item.product.name}</td>
                                <td>
                                    <input type="number" value="${item.quantity}" min="1" class="form-control"
                                           onchange="updateQuantity(${item.product.id}, this.value)" />
                                </td>
                                <td>${formatNumber(item.product.price)}</td>
                                <td>${formatNumber(item.product.price * item.quantity)}</td>
                                <td>
                                    <button onclick="removeFromCart(${item.product.id})" class="btn btn-danger btn-sm">X√≥a</button>
                                </td>
                            </tr>`;
                            cartBody.append(row);
                        });

                        $('#total-quantity').text(sumQuantity);
                        $('#total-price').text(formatNumber(sumPrice));
                    }
                }
            });
        }

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
        function updateQuantity(productId, quantity) {
            $.ajax({
                url: '/api/cart/update',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ productId: productId, quantity: parseInt(quantity) }),
                success: function() { loadCart(); } // T·∫£i l·∫°i gi·ªè h√†ng ƒë·ªÉ c·∫≠p nh·∫≠t
            });
        }

        // X√≥a s·∫£n ph·∫©m
        function removeFromCart(productId) {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) {
                $.ajax({
                    url: '/api/cart/remove/' + productId,
                    type: 'DELETE',
                    success: function() { loadCart(); }
                });
            }
        }

        // X√≥a to√†n b·ªô gi·ªè h√†ng
        function clearCart() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m s·∫°ch gi·ªè h√†ng?')) {
                $.ajax({
                    url: '/api/cart/clear',
                    type: 'DELETE',
                    success: function() { loadCart(); }
                });
            }
        }

        // T·∫£i gi·ªè h√†ng khi trang ƒë∆∞·ª£c m·ªü
        $(document).ready(function() {
            loadCart();
        });
    </script>
</th:block>

</body>
</html>